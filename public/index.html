<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Love Letter (4p) - Socket Demo</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
  />
  <style>
    main { padding-block: 1.5rem; }
    .form-grid { display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); align-items: end; }
    .pill-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    pre { max-height: 240px; overflow: auto; }
    .hidden { display: none; }
    .space-top { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <hgroup>
        <h1>Midnight Love Letter</h1>
      </hgroup>
    </header>

    <article>
      <h3>Lobby</h3>
      <div class="form-grid">
        <label>Room <input id="roomId" placeholder="lobby-1" /></label>
        <label>Name <input id="name" placeholder="Player" /></label>
        <button id="join" class="secondary">Join</button>
        <button id="start" class="contrast">Start Game</button>
      </div>
      <small id="status"></small>
    </article>

    <article data-requires-room>
      <h3>Players</h3>
      <div id="players" class="pill-row"></div>
    </article>

    <article data-requires-room data-requires-start>
      <h3>Your Hand</h3>
      <div class="form-grid">
        <label>Target
          <select id="target">
            <option value="">None</option>
          </select>
        </label>
      <label>Guard Guess (2-8)
        <input id="guess" type="number" min="2" max="8" />
      </label>
      </div>
      <div id="hand" class="pill-row space-top"></div>
    </article>

    <article data-requires-room data-requires-start>
      <h3>Discard</h3>
      <span id="deckInfo"></span>
      <div id="discard" class="pill-row"></div>
    </article>

    <article data-requires-room data-requires-start>
      <h3>Log</h3>
      <pre id="log"></pre>
    </article>

    <article data-requires-room data-requires-start>
      <h3>Debug State</h3>
      <pre id="state"></pre>
    </article>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomInput = document.getElementById('roomId');
    const nameInput = document.getElementById('name');
    const joinBtn = document.getElementById('join');
    const startBtn = document.getElementById('start');
    const statusEl = document.getElementById('status');
    const playersEl = document.getElementById('players');
    const handEl = document.getElementById('hand');
    const targetEl = document.getElementById('target');
    const guessEl = document.getElementById('guess');
    const discardEl = document.getElementById('discard');
    const deckInfoEl = document.getElementById('deckInfo');
    const logEl = document.getElementById('log');
    const stateEl = document.getElementById('state');
    const roomSections = document.querySelectorAll('[data-requires-room]');
    const startedSections = document.querySelectorAll('[data-requires-start]');

    const showRoomUI = (show) => {
      roomSections.forEach((el) => el.classList.toggle('hidden', !show));
    };

    const showStartedUI = (show) => {
      startedSections.forEach((el) => el.classList.toggle('hidden', !show));
    };

    showRoomUI(false);
    showStartedUI(false);

    let currentRoom = '';

    joinBtn.onclick = () => {
      const roomId = roomInput.value.trim() || 'lobby-1';
      currentRoom = roomId;
      socket.emit('join-room', { roomId, name: nameInput.value.trim() });
      statusEl.textContent = `Joined ${roomId}`;
    };

    startBtn.onclick = () => {
      if (!currentRoom) {
        statusEl.textContent = 'Join a room first.';
        return;
      }
      socket.emit('start-game', currentRoom);
    };

    socket.on('state', (state) => {
      showRoomUI(true);
      showStartedUI(Boolean(state.started));
      stateEl.textContent = JSON.stringify(state, null, 2);
      renderPlayers(state);
      renderHand(state);
      renderDiscard(state);
      renderLog(state);
      renderTargetOptions(state);
      deckInfoEl.textContent = `Deck: ${state.deckCount} | Burned: ${state.burns}`;
      const me = state.players.find((p) => p.isYou);
      if (state.ended && state.winner) {
        statusEl.textContent = `Round ended. Winner: ${state.winner.name}`;
      } else if (me?.isCurrent) {
        statusEl.textContent = 'Your turn';
      } else if (state.currentPlayer) {
        const current = state.players.find((p) => p.id === state.currentPlayer);
        statusEl.textContent = `Waiting for ${current?.name || 'player'}`;
      }
    });

    socket.on('error-message', (msg) => {
      statusEl.textContent = msg;
      if (!currentRoom) {
        showRoomUI(false);
        showStartedUI(false);
      }
    });

    function renderTargetOptions(state) {
      targetEl.innerHTML = '<option value="">None</option>';
      state.players
        .filter((p) => !p.isYou && !p.eliminated)
        .forEach((p) => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          targetEl.appendChild(opt);
        });
    }

    function renderPlayers(state) {
      playersEl.innerHTML = '';
      state.players.forEach((p) => {
        const chip = document.createElement('span');
        const flags = [
          p.isCurrent ? 'â˜…' : '',
          p.protected ? 'P' : '',
          p.eliminated ? 'X' : '',
          p.isYou ? 'you' : '',
        ]
          .filter(Boolean)
          .join(' ');
        chip.textContent = `${p.name} (${p.handCount})${flags ? ' [' + flags + ']' : ''}`;
        playersEl.appendChild(chip);
      });
    }

    function renderHand(state) {
      handEl.innerHTML = '';
      const hand = state.you?.hand || [];
      hand.forEach((card, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `${card.name} (${card.value})`;
        btn.onclick = () =>
          socket.emit('play-card', {
            roomId: currentRoom,
            cardIndex: idx,
            targetId: targetEl.value || null,
            guess: guessEl.value ? Number(guessEl.value) : undefined,
          });
        handEl.appendChild(btn);
      });
      if (!hand.length) {
        handEl.textContent = 'No cards yet. Start the game!';
      }
    }

    function renderDiscard(state) {
      const nameById = Object.fromEntries(state.players.map((p) => [p.id, p.name]));
      discardEl.innerHTML = state.discard
        .map((c) => `${c.by || 'Player'} played ${c.name}${c.target ? ' -> ' + (nameById[c.target] || c.target) : ''}`)
        .join(' | ');
    }

    function renderLog(state) {
      logEl.textContent = state.log.join('\n');
    }
  </script>
</body>
</html>
