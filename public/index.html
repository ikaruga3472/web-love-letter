<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Love Letter (4p) - Socket Demo</title>
  <style>
    :root { font-family: "Segoe UI", sans-serif; background: #0f172a; color: #e2e8f0; }
    body { margin: 0; padding: 24px; }
    .panel { background: #111827; border: 1px solid #1f2937; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
    input, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #1f2937; background: #0b1220; color: #e2e8f0; }
    button { cursor: pointer; font-weight: 600; }
    button.primary { background: linear-gradient(120deg, #22d3ee, #6366f1); border: none; color: #0b1220; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    #players span { display: inline-block; margin-right: 8px; padding: 6px 10px; border-radius: 999px; background: #1f2937; }
    #hand button { margin-right: 8px; margin-bottom: 8px; }
    pre { background: #0b1220; padding: 12px; border-radius: 8px; overflow: auto; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="row" style="gap: 8px 12px;">
      <label>Room <input id="roomId" placeholder="lobby-1" /></label>
      <label>Name <input id="name" placeholder="Player" /></label>
      <button id="join">Join</button>
      <button id="start" class="primary">Start Game</button>
      <span id="status"></span>
    </div>
  </div>

  <div class="panel">
    <h3>Players</h3>
    <div id="players"></div>
  </div>

  <div class="panel">
    <h3>Your Hand</h3>
    <div class="row" style="margin-bottom: 8px;">
      <label>Target
        <select id="target">
          <option value="">None</option>
        </select>
      </label>
      <label>Guard Guess (2-8)
        <input id="guess" type="number" min="2" max="8" style="width: 80px;" />
      </label>
    </div>
    <div id="hand"></div>
  </div>

  <div class="panel">
    <h3>Discard</h3>
    <div class="row" style="margin-bottom: 6px;">
      <span id="deckInfo"></span>
    </div>
    <div id="discard"></div>
  </div>

  <div class="panel">
    <h3>Log</h3>
    <pre id="log"></pre>
  </div>

  <div class="panel">
    <h3>Debug State</h3>
    <pre id="state"></pre>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomInput = document.getElementById('roomId');
    const nameInput = document.getElementById('name');
    const joinBtn = document.getElementById('join');
    const startBtn = document.getElementById('start');
    const statusEl = document.getElementById('status');
    const playersEl = document.getElementById('players');
    const handEl = document.getElementById('hand');
    const targetEl = document.getElementById('target');
    const guessEl = document.getElementById('guess');
    const discardEl = document.getElementById('discard');
    const deckInfoEl = document.getElementById('deckInfo');
    const logEl = document.getElementById('log');
    const stateEl = document.getElementById('state');

    let currentRoom = '';

    joinBtn.onclick = () => {
      const roomId = roomInput.value.trim() || 'lobby-1';
      currentRoom = roomId;
      socket.emit('join-room', { roomId, name: nameInput.value.trim() });
      statusEl.textContent = `Joined ${roomId}`;
    };

    startBtn.onclick = () => {
      if (!currentRoom) {
        statusEl.textContent = 'Join a room first.';
        return;
      }
      socket.emit('start-game', currentRoom);
    };

    socket.on('state', (state) => {
      stateEl.textContent = JSON.stringify(state, null, 2);
      renderPlayers(state);
      renderHand(state);
      renderDiscard(state);
      renderLog(state);
      renderTargetOptions(state);
      deckInfoEl.textContent = `Deck: ${state.deckCount} | Burned: ${state.burns}`;
      const me = state.players.find((p) => p.isYou);
      if (state.ended && state.winner) {
        statusEl.textContent = `Round ended. Winner: ${state.winner.name}`;
      } else if (me?.isCurrent) {
        statusEl.textContent = 'Your turn';
      } else if (state.currentPlayer) {
        const current = state.players.find((p) => p.id === state.currentPlayer);
        statusEl.textContent = `Waiting for ${current?.name || 'player'}`;
      }
    });

    socket.on('error-message', (msg) => {
      statusEl.textContent = msg;
    });

    function renderTargetOptions(state) {
      targetEl.innerHTML = '<option value="">None</option>';
      state.players
        .filter((p) => !p.isYou && !p.eliminated)
        .forEach((p) => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          targetEl.appendChild(opt);
        });
    }

    function renderPlayers(state) {
      playersEl.innerHTML = '';
      state.players.forEach((p) => {
        const chip = document.createElement('span');
        const flags = [
          p.isCurrent ? 'â˜…' : '',
          p.protected ? 'P' : '',
          p.eliminated ? 'X' : '',
          p.isYou ? 'you' : '',
        ]
          .filter(Boolean)
          .join(' ');
        chip.textContent = `${p.name} (${p.handCount})${flags ? ' [' + flags + ']' : ''}`;
        playersEl.appendChild(chip);
      });
    }

    function renderHand(state) {
      handEl.innerHTML = '';
      const hand = state.you?.hand || [];
      hand.forEach((card, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `${card.name} (${card.value})`;
        btn.onclick = () =>
          socket.emit('play-card', {
            roomId: currentRoom,
            cardIndex: idx,
            targetId: targetEl.value || null,
            guess: guessEl.value ? Number(guessEl.value) : undefined,
          });
        handEl.appendChild(btn);
      });
      if (!hand.length) {
        handEl.textContent = 'No cards yet. Start the game!';
      }
    }

    function renderDiscard(state) {
      const nameById = Object.fromEntries(state.players.map((p) => [p.id, p.name]));
      discardEl.innerHTML = state.discard
        .map((c) => `${c.by || 'Player'} played ${c.name}${c.target ? ' -> ' + (nameById[c.target] || c.target) : ''}`)
        .join(' | ');
    }

    function renderLog(state) {
      logEl.textContent = state.log.join('\n');
    }
  </script>
</body>
</html>
